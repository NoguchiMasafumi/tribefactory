<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title id='title1'>Tribe Factory</title>
        <link rel="stylesheet" href="https://tribefactory.netlify.app/css/tf_base2.css">
        <link rel="apple-touch-icon" sizes="76x76" href="https://tribefactory.netlify.app/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="https://tribefactory.netlify.app/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https://tribefactory.netlify.app/favicon/favicon-16x16.png">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <header id="header_container"></header>
        <div class="main-content">
            <main class="content-sidebar" id="sidebar_container"></main>


<aside class="content-main">
    <style>
        .flt_lef{float:left;}
        .tex_rig{text-align:right;}
        .mar_r30{margin-right:30px;}
        .tbl_td_fnt_s12 td{font-size:12px;}
    </style>
    <script>
        //***************************************//
        function st_sub(){
            document.getElementById('files').addEventListener('change', handleFileSelect, false);
        }
        //*************************************//
        function sleep(second) {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve()
                }, second * 1000)
            })
        }
        //*************************************//
        async function handleFileSelect(evt){
            var str_music_list=""
            const files = evt.target.files;

            // --- 変更点1: durationの正確な取得とリスト作成 ---
            // Promiseとイベントリスナーを使って、durationの読み込みを確実に待つ
            for(let int_loop2=0; int_loop2 < files.length; int_loop2++){
                const file = files[int_loop2];
                auo.src = URL.createObjectURL(file);
        
                // loadedmetadataイベントが発火するまで待機するPromise
                const duration_promise = new Promise(resolve => {
                    auo.onloadedmetadata = () => {
                        resolve(auo.duration);
                    };
                });
        
                const int1 = await duration_promise; // durationを取得できるまで待機
        
                str_music_list = str_music_list + "<tr><td>" + file.name + "</td><td class='tex_rig'>" + int1.toFixed(2) + "</td></tr>";
            }
            music_list.innerHTML=str_music_list
            //*//
            for(let int_loop1=0; int_loop1 < files.length; int_loop1++){
                const file = files[int_loop1];
                title.textContent = file.name;
                auo.src = URL.createObjectURL(file);
        
                // durationを取得するため再度 loadedmetadata を待機 (再生前にメタデータが必要)
                await new Promise(resolve => {
                    auo.onloadedmetadata = resolve;
                });
        
                // 再生が終了するのを待機するPromise
                const ended_promise = new Promise(resolve => {
                    auo.onended = resolve;
                });
        
                auo.play();
        
                await ended_promise; // 再生が終了するまで待機
            }
        }
    </script>
<h3>playfiles</h3>
<div class="flt_lef mar_r30">
    <span id="title"></span><br />
    <audio controls id="auo"></audio>
</div>

<div class="flt_lef">
    <input type="file" id="files" class="disp_no" name="files[]" multiple /><br />
    <table id="music_list" class="tbl_td_fnt_s12"></table>
</div>


</aside>

    
        </div>
        <footer id="footer-container"></footer>
        <script src="https://tribefactory.netlify.app/js/navi/header.js"></script>
        <script src="https://tribefactory.netlify.app/js/navi/sidebar.js"></script>
        <script src="https://tribefactory.netlify.app/js/navi/footer.js"></script>
    </body>
</html>


