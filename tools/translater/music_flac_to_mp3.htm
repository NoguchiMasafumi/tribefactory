<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLAC to MP3 Converter (ffmpeg.wasm)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f4f7f9;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #fileInput {
            margin-bottom: 20px;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
            min-height: 20px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
    </style>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ¶ FLAC to MP3 å¤‰æ›ãƒ„ãƒ¼ãƒ«</h1>
    
    <input type="file" id="fileInput" accept=".flac">
    
    <button id="convertButton" disabled>
        FLACã‚’MP3ã«å¤‰æ›
    </button>
    
    <div id="status">
        åˆæœŸåŒ–ä¸­...ï¼ˆæ•°ç§’ãŠå¾…ã¡ãã ã•ã„ï¼‰
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true, // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚’å‡ºåŠ›
        corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js' // Coreãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®š
    });

    const fileInput = document.getElementById('fileInput');
    const convertButton = document.getElementById('convertButton');
    const statusDiv = document.getElementById('status');

    let inputFileName = '';

    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™
     * @param {string} message - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {string} className - ã‚¯ãƒ©ã‚¹å ('success', 'error', '')
     */
    function updateStatus(message, className = '') {
        statusDiv.innerHTML = message;
        statusDiv.className = className;
    }

    /**
     * ffmpeg.wasmã®åˆæœŸåŒ–å‡¦ç†
     */
    async function initFFmpeg() {
        try {
            updateStatus('FFmpegåˆæœŸåŒ–ä¸­... (Wasmãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™)', '');
            await ffmpeg.load();
            updateStatus('âœ… åˆæœŸåŒ–å®Œäº†ï¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦å¤‰æ›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
            convertButton.disabled = false;
        } catch (error) {
            updateStatus('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message + 'ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
        }
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
     */
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            inputFileName = file.name;
            convertButton.disabled = false;
            updateStatus(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸ: ${inputFileName}`, '');
        } else {
            convertButton.disabled = true;
            updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', '');
        }
    });

    /**
     * å¤‰æ›ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    convertButton.addEventListener('click', async () => {
        if (!fileInput.files.length) {
            updateStatus('âŒ FLACãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }
        
        const flacFile = fileInput.files[0];
        const outputFileName = inputFileName.replace(/\.flac$/i, '') + '.mp3'; // .flacã‚’.mp3ã«ç½®æ›
        
        convertButton.disabled = true;
        updateStatus('å¤‰æ›å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™... (CPUè² è·ãŒé«˜ã„å‡¦ç†ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„)', '');

        try {
            // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«æ›¸ãè¾¼ã‚€
            ffmpeg.FS('writeFile', inputFileName, await fetchFile(flacFile));
            updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚MP3ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­...', '');

            // 2. å¤‰æ›ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ (CBR 320kbpsã®MP3ã«å¤‰æ›)
            // -i: å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«
            // -b:a 320k: éŸ³å£°ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆã‚’320kbpsã«è¨­å®šï¼ˆé«˜å“è³ªï¼‰
            // -vn: ãƒ“ãƒ‡ã‚ªãƒˆãƒ©ãƒƒã‚¯ã‚’å«ã¾ãªã„ï¼ˆå¿µã®ãŸã‚ï¼‰
            // -y: ä¸Šæ›¸ãã‚’è¨±å¯
            await ffmpeg.run('-i', inputFileName, '-b:a', '320k', '-vn', '-y', outputFileName);
            updateStatus('ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...', '');

            // 3. å¤‰æ›ã•ã‚ŒãŸMP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å‡ºã™
            const data = ffmpeg.FS('readFile', outputFileName);

            // 4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦å®Ÿè¡Œ
            const blob = new Blob([data.buffer], { type: 'audio/mp3' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = outputFileName;
            document.body.appendChild(a);
            a.click();
            
            // 5. å¾Œå‡¦ç†
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            ffmpeg.FS('unlink', inputFileName); // ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            ffmpeg.FS('unlink', outputFileName); // ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤

            updateStatus(`ğŸ‰ å¤‰æ›æˆåŠŸï¼ **${outputFileName}** ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚`, 'success');

        } catch (error) {
            updateStatus('âŒ å¤‰æ›ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' + error.message, 'error');
            console.error(error);
        } finally {
            convertButton.disabled = false;
        }
    });

    // ãƒšãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«FFmpegã®åˆæœŸåŒ–ã‚’é–‹å§‹
    initFFmpeg();
</script>

</body>
</html>